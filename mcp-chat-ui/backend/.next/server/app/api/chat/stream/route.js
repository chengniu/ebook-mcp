"use strict";(()=>{var a={};a.id=903,a.ids=[903],a.modules={261:a=>{a.exports=require("next/dist/shared/lib/router/utils/app-paths")},846:a=>{a.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},1815:(a,b,c)=>{c.r(b),c.d(b,{handler:()=>K,patchFetch:()=>J,routeModule:()=>F,serverHooks:()=>I,workAsyncStorage:()=>G,workUnitAsyncStorage:()=>H});var d={};c.r(d),c.d(d,{OPTIONS:()=>E,POST:()=>D});var e=c(6559),f=c(8088),g=c(7719),h=c(6191),i=c(1289),j=c(261),k=c(2603),l=c(9893),m=c(4823),n=c(7220),o=c(6946),p=c(7912),q=c(9786),r=c(6143),s=c(6439),t=c(3365),u=c(2190),v=c(7746),w=c(6688),x=c(9812),y=c(3471),z=c(5108),A=c(2201),B=c(6918);async function C(a){if("POST"!==a.method)return u.NextResponse.json({error:"Method not allowed",message:"Only POST method is allowed"},{status:405});await (0,y.Zn)();let b=await a.json(),c=(0,x.AQ)(b),{apiKey:d,baseUrl:e,systemPrompt:f,temperature:g,maxTokens:h,availableTools:i}=b;if(!d||"string"!=typeof d)throw new w.yI("API key is required for chat requests");try{let a=(0,z.N5)(c.provider),b=(0,z.tr)({provider:c.provider,apiKey:d,baseUrl:e||a.baseUrl,model:c.model,maxRetries:a.maxRetries,retryDelay:a.retryDelay,timeout:a.timeout}),j=(0,A.wF)(),k=(0,B.B2)(b,j),l=new TextEncoder,m=new ReadableStream({async start(a){try{for await(let b of(await k.processStreamingQuery({messages:c.messages,sessionId:c.sessionId,provider:c.provider,model:c.model,availableTools:i||[],systemPrompt:f,temperature:g,maxTokens:h}))){let c=JSON.stringify(b),d=`data: ${c}

`;a.enqueue(l.encode(d))}a.enqueue(l.encode("data: [DONE]\n\n")),a.close()}catch(d){console.error("Streaming error:",d);let b=JSON.stringify({error:d instanceof Error?d.message:"Unknown streaming error",sessionId:c.sessionId,isStreaming:!0});a.enqueue(l.encode(`data: ${b}

`)),a.close()}}});return new u.NextResponse(m,{headers:{"Content-Type":"text/event-stream","Cache-Control":"no-cache",Connection:"keep-alive","Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"POST, OPTIONS","Access-Control-Allow-Headers":"Content-Type"}})}catch(b){console.error("Stream setup error:",b);let a=b instanceof Error?b.message:"Unknown error occurred";return u.NextResponse.json({error:a,sessionId:c.sessionId},{status:b instanceof w.yI?400:500})}}let D=(0,v.gx)((0,w._P)(C)),E=(0,v.gx)(async()=>new u.NextResponse(null,{status:200})),F=new e.AppRouteRouteModule({definition:{kind:f.RouteKind.APP_ROUTE,page:"/api/chat/stream/route",pathname:"/api/chat/stream",filename:"route",bundlePath:"app/api/chat/stream/route"},distDir:".next",projectDir:"",resolvedPagePath:"/Users/onebird/github/ebook-mcp/mcp-chat-ui/backend/src/app/api/chat/stream/route.ts",nextConfigOutput:"",userland:d}),{workAsyncStorage:G,workUnitAsyncStorage:H,serverHooks:I}=F;function J(){return(0,g.patchFetch)({workAsyncStorage:G,workUnitAsyncStorage:H})}async function K(a,b,c){var d;let e="/api/chat/stream/route";"/index"===e&&(e="/");let g=await F.prepare(a,b,{srcPage:e,multiZoneDraftMode:"false"});if(!g)return b.statusCode=400,b.end("Bad Request"),null==c.waitUntil||c.waitUntil.call(c,Promise.resolve()),null;let{buildId:u,params:v,nextConfig:w,isDraftMode:x,prerenderManifest:y,routerServerContext:z,isOnDemandRevalidate:A,revalidateOnlyGenerated:B,resolvedPathname:C}=g,D=(0,j.normalizeAppPath)(e),E=!!(y.dynamicRoutes[D]||y.routes[C]);if(E&&!x){let a=!!y.routes[C],b=y.dynamicRoutes[D];if(b&&!1===b.fallback&&!a)throw new s.NoFallbackError}let G=null;!E||F.isDev||x||(G="/index"===(G=C)?"/":G);let H=!0===F.isDev||!E,I=E&&!H,J=a.method||"GET",K=(0,i.getTracer)(),L=K.getActiveScopeSpan(),M={params:v,prerenderManifest:y,renderOpts:{experimental:{dynamicIO:!!w.experimental.dynamicIO,authInterrupts:!!w.experimental.authInterrupts},supportsDynamicResponse:H,incrementalCache:(0,h.getRequestMeta)(a,"incrementalCache"),cacheLifeProfiles:null==(d=w.experimental)?void 0:d.cacheLife,isRevalidate:I,waitUntil:c.waitUntil,onClose:a=>{b.on("close",a)},onAfterTaskError:void 0,onInstrumentationRequestError:(b,c,d)=>F.onRequestError(a,b,d,z)},sharedContext:{buildId:u}},N=new k.NodeNextRequest(a),O=new k.NodeNextResponse(b),P=l.NextRequestAdapter.fromNodeNextRequest(N,(0,l.signalFromNodeResponse)(b));try{let d=async c=>F.handle(P,M).finally(()=>{if(!c)return;c.setAttributes({"http.status_code":b.statusCode,"next.rsc":!1});let d=K.getRootSpanAttributes();if(!d)return;if(d.get("next.span_type")!==m.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${d.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let e=d.get("next.route");if(e){let a=`${J} ${e}`;c.setAttributes({"next.route":e,"http.route":e,"next.span_name":a}),c.updateName(a)}else c.updateName(`${J} ${a.url}`)}),g=async g=>{var i,j;let k=async({previousCacheEntry:f})=>{try{if(!(0,h.getRequestMeta)(a,"minimalMode")&&A&&B&&!f)return b.statusCode=404,b.setHeader("x-nextjs-cache","REVALIDATED"),b.end("This page could not be found"),null;let e=await d(g);a.fetchMetrics=M.renderOpts.fetchMetrics;let i=M.renderOpts.pendingWaitUntil;i&&c.waitUntil&&(c.waitUntil(i),i=void 0);let j=M.renderOpts.collectedTags;if(!E)return await (0,o.I)(N,O,e,M.renderOpts.pendingWaitUntil),null;{let a=await e.blob(),b=(0,p.toNodeOutgoingHttpHeaders)(e.headers);j&&(b[r.NEXT_CACHE_TAGS_HEADER]=j),!b["content-type"]&&a.type&&(b["content-type"]=a.type);let c=void 0!==M.renderOpts.collectedRevalidate&&!(M.renderOpts.collectedRevalidate>=r.INFINITE_CACHE)&&M.renderOpts.collectedRevalidate,d=void 0===M.renderOpts.collectedExpire||M.renderOpts.collectedExpire>=r.INFINITE_CACHE?void 0:M.renderOpts.collectedExpire;return{value:{kind:t.CachedRouteKind.APP_ROUTE,status:e.status,body:Buffer.from(await a.arrayBuffer()),headers:b},cacheControl:{revalidate:c,expire:d}}}}catch(b){throw(null==f?void 0:f.isStale)&&await F.onRequestError(a,b,{routerKind:"App Router",routePath:e,routeType:"route",revalidateReason:(0,n.c)({isRevalidate:I,isOnDemandRevalidate:A})},z),b}},l=await F.handleResponse({req:a,nextConfig:w,cacheKey:G,routeKind:f.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:y,isRoutePPREnabled:!1,isOnDemandRevalidate:A,revalidateOnlyGenerated:B,responseGenerator:k,waitUntil:c.waitUntil});if(!E)return null;if((null==l||null==(i=l.value)?void 0:i.kind)!==t.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==l||null==(j=l.value)?void 0:j.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});(0,h.getRequestMeta)(a,"minimalMode")||b.setHeader("x-nextjs-cache",A?"REVALIDATED":l.isMiss?"MISS":l.isStale?"STALE":"HIT"),x&&b.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let m=(0,p.fromNodeOutgoingHttpHeaders)(l.value.headers);return(0,h.getRequestMeta)(a,"minimalMode")&&E||m.delete(r.NEXT_CACHE_TAGS_HEADER),!l.cacheControl||b.getHeader("Cache-Control")||m.get("Cache-Control")||m.set("Cache-Control",(0,q.getCacheControlHeader)(l.cacheControl)),await (0,o.I)(N,O,new Response(l.value.body,{headers:m,status:l.value.status||200})),null};L?await g(L):await K.withPropagatedContext(a.headers,()=>K.trace(m.BaseServerSpan.handleRequest,{spanName:`${J} ${a.url}`,kind:i.SpanKind.SERVER,attributes:{"http.method":J,"http.target":a.url}},g))}catch(b){if(L||b instanceof s.NoFallbackError||await F.onRequestError(a,b,{routerKind:"App Router",routePath:D,routeType:"route",revalidateReason:(0,n.c)({isRevalidate:I,isOnDemandRevalidate:A})}),E)throw b;return await (0,o.I)(N,O,new Response(null,{status:500})),null}}},3033:a=>{a.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},3295:a=>{a.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},3471:(a,b,c)=>{c.d(b,{Zn:()=>g});var d=c(2201);let e=!1;async function f(){if(!e)try{console.log("Initializing backend services..."),await (0,d.C8)(),console.log("Session manager initialized"),e=!0,console.log("Backend initialization complete")}catch(a){throw console.error("Failed to initialize backend:",a),a}}async function g(){e||await f()}},3873:a=>{a.exports=require("path")},4870:a=>{a.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6439:a=>{a.exports=require("next/dist/shared/lib/no-fallback-error.external")},6918:(a,b,c)=>{c.d(b,{B2:()=>f});var d=c(6688);class e{constructor(a,b){this.llmService=a,this.sessionManager=b}async processQuery(a){try{this.validateProcessQueryRequest(a);try{await this.sessionManager.getSession(a.sessionId)}catch(b){await this.sessionManager.createSession(a.provider,a.model,[],a.messages[0])}let b={messages:this.constructMessageHistory(a.messages,a.systemPrompt,a.availableTools).map(a=>({role:a.role,content:a.content,tool_calls:a.toolCalls,tool_call_id:a.toolCallId})),model:a.model,temperature:a.temperature??.7,maxTokens:a.maxTokens??1e3};a.availableTools&&a.availableTools.length>0&&(b.tools=this.formatToolsForLLM(a.availableTools),b.toolChoice="auto");let c=await this.llmService.generateCompletion(b),d={sessionId:a.sessionId,reply:c.content,toolCalls:c.toolCalls,usage:c.usage,finishReason:c.finishReason};return await this.updateSessionWithResponse(a.sessionId,a.messages,c),d}catch(a){if(console.error("Chat processing error:",a),a instanceof d.yI)throw a;throw new d.PO(`Failed to process chat query: ${a instanceof Error?a.message:"Unknown error"}`)}}async processStreamingQuery(a){let b=await this.processQuery(a);return async function*(){yield{...b,isStreaming:!0,streamId:`stream_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}}()}constructSystemPrompt(a,b){let c=b||`You are a helpful AI assistant with access to various tools through the Model Context Protocol (MCP). 

When you need to use a tool to help the user, you should:
1. Explain what you're going to do
2. Call the appropriate tool with the correct parameters
3. Wait for the tool result
4. Interpret and explain the results to the user

Always be clear about what tools you're using and why. If a tool call fails, explain the error and suggest alternatives if possible.`;if(!a||0===a.length)return c;let d=a.map(a=>`- ${a.name}: ${a.description}`).join("\n");return`${c}

Available tools:
${d}

Use these tools when they can help answer the user's questions or complete their requests.`}constructMessageHistory(a,b,c){let d=[];if(b||c&&c.length>0){let a=this.constructSystemPrompt(c,b);d.push({id:`system_${Date.now()}`,role:"system",content:a,timestamp:new Date})}return d.push(...a),d}formatToolsForLLM(a){return a.map(a=>({type:"function",function:{name:a.name,description:a.description,parameters:a.inputSchema}}))}async updateSessionWithResponse(a,b,c){try{for(let c of b)await this.sessionManager.addMessage(a,c);if(c.content||c.toolCalls){let b={id:`assistant_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,role:"assistant",content:c.content||"",timestamp:new Date,toolCalls:c.toolCalls};await this.sessionManager.addMessage(a,b)}let d=await this.sessionManager.getSession(a);if("New Chat"===d.title&&d.messages.length>=2)try{await this.sessionManager.generateSessionTitle(a,this.llmService)}catch(a){console.warn("Failed to generate session title:",a)}}catch(a){console.error("Failed to update session:",a)}}validateProcessQueryRequest(a){if(!a.messages||!Array.isArray(a.messages))throw new d.yI("Messages must be an array");if(0===a.messages.length)throw new d.yI("Messages array cannot be empty");if(!a.sessionId||"string"!=typeof a.sessionId)throw new d.yI("Session ID must be a valid string");if(!a.provider||!["openai","deepseek","openrouter"].includes(a.provider))throw new d.yI("Provider must be one of: openai, deepseek, openrouter");if(!a.model||"string"!=typeof a.model)throw new d.yI("Model must be a valid string");if(a.messages.forEach((a,b)=>{if(!a.id||"string"!=typeof a.id)throw new d.yI(`Message at index ${b} must have a valid id`);if(!a.role||!["user","assistant","tool","system"].includes(a.role))throw new d.yI(`Message at index ${b} must have a valid role`);if("string"!=typeof a.content)throw new d.yI(`Message at index ${b} must have string content`)}),void 0!==a.temperature&&(a.temperature<0||a.temperature>2))throw new d.yI("Temperature must be between 0 and 2");if(void 0!==a.maxTokens&&a.maxTokens<=0)throw new d.yI("Max tokens must be positive")}static detectToolCalls(a){return a.toolCalls||[]}static formatToolCallForConfirmation(a){let b={};try{b=JSON.parse(a.function.arguments)}catch(c){console.warn("Failed to parse tool call arguments:",c),b={raw_arguments:a.function.arguments}}return{name:a.function.name,description:`Execute ${a.function.name} with the provided parameters`,parameters:b}}static createToolResultMessage(a,b,c=!1){return{id:`tool_result_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,role:"tool",content:c?`Error: ${b}`:b,timestamp:new Date,toolCallId:a}}}function f(a,b){return new e(a,b)}},9021:a=>{a.exports=require("fs")},9294:a=>{a.exports=require("next/dist/server/app-render/work-async-storage.external.js")},9812:(a,b,c)=>{c.d(b,{AQ:()=>e,Sj:()=>g,lP:()=>f});var d=c(6688);function e(a){if(!a||"object"!=typeof a)throw new d.yI("Request body must be a valid JSON object");let{messages:b,sessionId:c,provider:e,model:f,apiKey:g,baseUrl:h,systemPrompt:i,temperature:j,maxTokens:k,availableTools:l}=a;if(!Array.isArray(b))throw new d.yI("Messages must be an array");if(0===b.length)throw new d.yI("Messages array cannot be empty");if(b.forEach((a,b)=>{if(!a.id||"string"!=typeof a.id)throw new d.yI(`Message at index ${b} must have a valid id`);if(!a.role||!["user","assistant","tool","system"].includes(a.role))throw new d.yI(`Message at index ${b} must have a valid role`);if("string"!=typeof a.content)throw new d.yI(`Message at index ${b} must have string content`)}),!c||"string"!=typeof c)throw new d.yI("Session ID must be a valid string");if(!e||!["openai","deepseek","openrouter"].includes(e))throw new d.yI("Provider must be one of: openai, deepseek, openrouter");if(!f||"string"!=typeof f)throw new d.yI("Model must be a valid string");if(void 0!==g&&"string"!=typeof g)throw new d.yI("API key must be a string");if(void 0!==h&&"string"!=typeof h)throw new d.yI("Base URL must be a string");if(void 0!==i&&"string"!=typeof i)throw new d.yI("System prompt must be a string");if(void 0!==j&&("number"!=typeof j||j<0||j>2))throw new d.yI("Temperature must be a number between 0 and 2");if(void 0!==k&&("number"!=typeof k||k<=0))throw new d.yI("Max tokens must be a positive number");if(void 0!==l&&!Array.isArray(l))throw new d.yI("Available tools must be an array");return{messages:b.map(a=>({...a,timestamp:a.timestamp?new Date(a.timestamp):new Date})),sessionId:c,provider:e,model:f,apiKey:g,baseUrl:h,systemPrompt:i,temperature:j,maxTokens:k,availableTools:l}}function f(a){if(!a||"object"!=typeof a)throw new d.yI("Request body must be a valid JSON object");let{toolCall:b,sessionId:c,messages:e}=a;if(!b||"object"!=typeof b)throw new d.yI("Tool call must be a valid object");if(!b.id||"string"!=typeof b.id)throw new d.yI("Tool call must have a valid id");if("function"!==b.type)throw new d.yI('Tool call type must be "function"');if(!b.function||"object"!=typeof b.function)throw new d.yI("Tool call must have a valid function object");if(!b.function.name||"string"!=typeof b.function.name)throw new d.yI("Tool call function must have a valid name");if("string"!=typeof b.function.arguments)throw new d.yI("Tool call function arguments must be a string");if(!c||"string"!=typeof c)throw new d.yI("Session ID must be a valid string");if(!Array.isArray(e))throw new d.yI("Messages must be an array");return{toolCall:b,sessionId:c,messages:e.map(a=>({...a,timestamp:a.timestamp?new Date(a.timestamp):new Date}))}}function g(a){if(!a||"object"!=typeof a)throw new d.yI("Settings must be a valid JSON object");if(a.llmProviders&&!Array.isArray(a.llmProviders))throw new d.yI("LLM providers must be an array");if(a.mcpServers&&!Array.isArray(a.mcpServers))throw new d.yI("MCP servers must be an array");if(a.preferences&&"object"!=typeof a.preferences)throw new d.yI("Preferences must be an object");return a}}};var b=require("../../../../webpack-runtime.js");b.C(a);var c=b.X(0,[985,55,407],()=>b(b.s=1815));module.exports=c})();